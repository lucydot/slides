<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>reveal-md</title>
    <link rel="stylesheet" href="./css/reveal.css" />
    <link rel="stylesheet" href="./css/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/zenburn.css" />
    <link rel="stylesheet" href="./css/print/paper.css" type="text/css" media="print" />

  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">~~~python
"""
Carbon and kWh calculator. Searches folder for slurm job output files. 
Calculates the total core hours used.
You can specify a start date for the seach.
Uses simple model (http://www.archer.ac.uk/about-archer/hardware/, 
carbon trust) to convert this to kWh and kg of carbon.
Requires Python 3.5. For start date functionality requires Mac OS.
"""
import datetime
import time
import os
import glob
import argparse
import sys

folder = sys.argv[1]
startdate = sys.argv[2]

TotalNodeHours = 0
nodeHours = 0
for filename in glob.iglob(folder+"/**/*.o[!ut]*",recursive=True):
    if startdate:
        stat = os.stat(filename)
        creationDate = stat.st_birthtime
        if creationDate > startdate:
           for line in open(filename):
        	     if "Resources allocated:" in line:
           		  ncpus = line.split("ncpus=")[1].split(",vmem")[0]
            		  walltime = line.split("walltime=")[1]
            		  with open(folder+"/FilesFound.txt","a") as textfile:
                	      textfile.write(filename+'\n')

            		  nodes = int(ncpus) / 24
                   hours = int(walltime[:2])+int(walltime[3:5])/
                           60+int(walltime[6:8])/3600
                   nodeHours = nodes*hours
    else:
        for line in open(filename):
        	     if "Resources allocated:" in line:
           		  ncpus = line.split("ncpus=")[1].split(",vmem")[0]
            		  walltime = line.split("walltime=")[1]
            		  with open(folder+"/FilesFound.txt","a") as textfile:
                	      textfile.write(filename+'\n')

            		  nodes = int(ncpus) / 24
                   hours = int(walltime[:2])+int(walltime[3:5])/
                           60+int(walltime[6:8])/3600
                   nodeHours = nodes*hours
    
    if nodeHours is not None:
        TotalNodeHours += nodeHours
    
if TotalNodeHours==0:
    print ("zero node hours found....aborting...")

else:
	kWh = TotalNodeHours * (1200/4920)
	kgCo2 = kWh*0.5246
	text = """Total kWh for this folder: {0} \n
	       Total kg of CO2 for this folder: {1}""".format(kWh, kgCo2)
	print (text)   
~~~
</script></section></div>
    </div>

    <script src="./lib/js/head.min.js"></script>
    <script src="./js/reveal.js"></script>

    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // Optional libraries used to extend on reveal.js
      var deps = [
        { src: './lib/js/classList.js', condition: function() { return !document.body.classList; } },
        { src: './plugin/markdown/marked.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
        { src: './plugin/markdown/markdown.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
        { src: './plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: './plugin/zoom-js/zoom.js', async: true },
        { src: './plugin/notes/notes.js', async: true },
        { src: './plugin/math/math.js', async: true }
      ];

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        dependencies: deps
      };

      // options from URL query string
      var queryOptions = Reveal.getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
